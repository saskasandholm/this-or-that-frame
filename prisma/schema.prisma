// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Category {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  topics      Topic[]
  submissions TopicSubmission[]
}

model Topic {
  id         Int       @id @default(autoincrement())
  name       String
  categoryId Int
  category   Category  @relation(fields: [categoryId], references: [id])
  optionA    String
  optionB    String
  imageA     String?
  imageB     String?
  startDate  DateTime  @default(now())
  endDate    DateTime?
  isActive   Boolean   @default(true)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  votes      Vote[]
  submissionId Int?    // Reference to the original submission if created from one
  submission  TopicSubmission? @relation(fields: [submissionId], references: [id])

  @@index([categoryId])
  @@index([isActive])
  @@index([startDate, endDate])
  @@index([submissionId])
}

model Vote {
  id        Int      @id @default(autoincrement())
  topicId   Int
  topic     Topic    @relation(fields: [topicId], references: [id])
  fid       Int
  choice    String   // 'A' or 'B'
  timestamp DateTime @default(now())
  userStreak UserStreak? @relation(fields: [fid], references: [fid], onDelete: Cascade)

  @@unique([topicId, fid])
  @@index([topicId])
  @@index([fid])
}

// New models for streaks and achievements
model UserStreak {
  id             Int      @id @default(autoincrement())
  fid            Int      @unique
  currentStreak  Int      @default(1)
  longestStreak  Int      @default(1)
  lastVoteDate   DateTime @default(now())
  totalVotes     Int      @default(1)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  votes          Vote[]
  achievements   UserAchievement[]
  submissions    TopicSubmission[]
}

model Achievement {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String
  badgeIcon   String   // Emoji or icon name
  badgeColor  String   // CSS gradient or color value
  threshold   Int      // Number required to earn this achievement
  type        String   // 'streak', 'votes', 'rare', 'divisive', etc.
  createdAt   DateTime @default(now())
  users       UserAchievement[]
}

model UserAchievement {
  id            Int         @id @default(autoincrement())
  fid           Int
  achievementId Int
  achievement   Achievement @relation(fields: [achievementId], references: [id])
  userStreak    UserStreak  @relation(fields: [fid], references: [fid], onDelete: Cascade)
  earnedAt      DateTime    @default(now())
  
  @@unique([fid, achievementId])
  @@index([fid])
  @@index([achievementId])
}

// New model for user-generated topic submissions
model TopicSubmission {
  id          Int       @id @default(autoincrement())
  name        String
  optionA     String
  optionB     String
  categoryId  Int
  category    Category  @relation(fields: [categoryId], references: [id])
  fid         Int       // Farcaster ID of the submitting user
  userStreak  UserStreak @relation(fields: [fid], references: [fid], onDelete: Cascade)
  status      String    @default("pending") // "pending", "approved", "rejected"
  reason      String?   // Reason for rejection if rejected
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  reviewedAt  DateTime?
  reviewedBy  Int?      // FID of the admin who reviewed this submission
  topics      Topic[]   // If approved and converted to a topic

  @@index([fid])
  @@index([categoryId])
  @@index([status])
  @@index([reviewedBy])
}

// New model for admin users (based on FID)
model Admin {
  id          Int       @id @default(autoincrement())
  fid         Int       @unique
  isActive    Boolean   @default(true)
  permissions String    @default("moderate") // "moderate", "full_admin"
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  createdBy   Int?      // FID of admin who created this admin (null for first admin)

  @@index([fid])
} 